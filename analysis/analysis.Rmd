```{r}
library(dplyr)
library(knitr)
library(tidyr)
```

```{r}
df <- read.table('../data/repetition.tsv', sep='\t', quote='',
                 stringsAsFactors=F, header=T)
df$p_rep <- as.numeric(df$p_rep)
```

## General distribution of repetition

For all poems:

```{r p_rep-dist, fig.width=15}
par(mfrow=c(1, 2))
hist(df$p_rep,
     main="Histogram of proportion of repeated verses",
     xlab="prop. of repeated verses")
plot(1:nrow(df), df$p_rep,
     main="Rank plot of proportion of repeated verses",
     xlab="rank", ylab="prop. of repeated verses")
```

Excluding the poems with zero repetition:

```{r p_rep-dist-nonzero, fig.width=15}
p_rep_nonzero = df %>% filter(p_rep > 0) %>% pull(p_rep)
par(mfrow=c(1, 2))
hist(p_rep_nonzero,
     main="Histogram of proportion of repeated verses",
     xlab="prop. of repeated verses")
plot(1:length(p_rep_nonzero), p_rep_nonzero,
     main="Rank plot of proportion of repeated verses",
     xlab="rank", ylab="prop. of repeated verses")
```

## By poem length

Are longer poems more likely to contain repetition? The plots below
indicate that it is the case. Here, we plot the *cumulative p_rep* of
all poems longer than a certain length, against the given length.
The cumulative p_rep is calculated as:
```
p_rep = (sum(number_of_lines) - sum(number_of_clusters)) / sum(number_of_lines)
```
where the sum goes over all the poems longer than the chosen length.

```{r cum_p_rep-length}
df2 <- df %>%
  arrange(desc(n_verses))
plot(df2$n_verses, (cumsum(df2$n_verses)-cumsum(df2$n_clust)) / cumsum(df2$n_verses),
     xlab="poem length", ylab="cumulative p_rep")
```

The next plot shows the distribution of `p_rep` for different groups of poems,
where groups are based on length ranges.

```{r box-p_rep-length}
df2 <- df %>%
  mutate(length_class = factor(case_when(
    n_verses < 5 ~ "[0, 5)",
    n_verses >= 5 & n_verses < 10 ~ "[5, 10)",
    n_verses >= 10 & n_verses < 20 ~ "[10, 20)",
    n_verses >= 20 & n_verses < 30 ~ "[20, 30)",
    n_verses >= 30 & n_verses < 50 ~ "[30, 50)",
    n_verses >= 50 & n_verses < 100 ~ "[50, 100)",
    n_verses >= 100 ~ "[100, +inf)"
  ),
  c("[0, 5)", "[5, 10)", "[10, 20)", "[20, 30)", "[30, 50)",
    "[50, 100)", "[100, +inf)")))
boxplot(p_rep ~ length_class, df2,
        main = "Repetition by length group",
        xlab = "Length group", ylab = "p_rep")
```

## By type

Most repetetive types (only types containing at least 10 poems):
```{r}
df %>%
  separate_rows(types, sep="; ") %>%
  group_by(types) %>%
  mutate(n = n(), avg_p_rep = mean(p_rep),
         example = paste0("[", p_rep, "](", link, ")")) %>%
  filter(row_number() <= 10) %>%
  summarize(n = first(n), avg_p_rep = first(avg_p_rep), examples=paste(example, collapse="; ")) %>%
  filter(n > 10) %>%
  arrange(desc(avg_p_rep)) %>%
  head(n = 20) %>%
  kable()
```

TODO questions:
- for poems with high repetition, do the repeating lines always repeat? or is it possible for them to also be "individual lines" in another poem?

